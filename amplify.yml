version: 1

frontend:
  phases:
    preBuild:
      commands:
        - npm ci

    build:
      commands:
        # ðŸ”´ Fail fast if required env vars are missing
        - test -n "$databaseURL"
        - test -n "$slackBotToken"
        - test -n "$NEXT_PUBLIC_userName"
        - test -n "$NEXT_PUBLIC_password"

        # ðŸ§¹ Clean old env files
        - rm -f .env .env.production

        # âœ… Server-only envs (used in API routes / server code)
        - echo "databaseURL=$databaseURL" >> .env
        - echo "slackBotToken=$slackBotToken" >> .env

        # âœ… Public envs (used in client/browser code)
        - echo "NEXT_PUBLIC_userName=$NEXT_PUBLIC_userName" >> .env
        - echo "NEXT_PUBLIC_password=$NEXT_PUBLIC_password" >> .env

        # Next.js production env file
        - cp .env .env.production

        # Build Next.js
        - npm run build

  artifacts:
    baseDirectory: .next
    files:
      - "**/*"

  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
